<!DOCTYPE html>
<style>
  body {
    font-family: Inter, sans-serif;
    font-weight: 300;
    background-color: var(--figma-color-bg);
    color: var(--figma-color-text);
    padding: 12px;
  }
  a {
    color: var(--figma-color-text-brand);
  }

  .plugin-divider {
    display: block;
    border: none;
    border-bottom: solid 1px var(--figma-color-border);
    margin: 20px 0;
  }

  .plugin-note {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .plugin-note > svg {
    color: var(--figma-color-text-secondary);
    display: flex;
    width: 15px;
    height: 15px;
    flex-shrink: 0;
  }
  .plugin-note > p {
    color: var(--figma-color-text-secondary);
    font-size: 0.7rem;
    padding: 0;
    margin: 0;
  }

  .node-design-ui {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: nowrap;
  }
  .node-design-ui.--with-textarea {
    width: 100%;
    margin-bottom: 12px;
  }
  .node-design-ui__textarea {
    width: 100%;
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    gap: 12px;
  }
  .node-design-ui__number {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    gap: 4px;
  }
  .node-design-ui__number > label,
  .node-design-ui__textarea > label {
    display: inline-block;
    width: 88px;
    flex-shrink: 0;
    color: var(--figma-color-text-secondary);
    font-size: 0.7rem;
  }
  .node-design-ui__number > p,
  .node-design-ui__textarea > p {
    display: inline-block;
    color: var(--figma-color-text-primary);
    font-size: 0.7rem;
  }

  .button-action {
    margin-top: 20px;
    font-size: 0.7rem;
    width: 100%;
    padding: 12px 8px;
    border-radius: 5px;
    background-color: var(--figma-color-bg-brand);
    color: var(--figma-color-text-onbrand);
    border: solid 1px var(--figma-color-border-onbrand);
    cursor: pointer;
  }
  .button-action:hover {
    background-color: var(--figma-color-bg-brand-hover);
    color: var(--figma-color-text-onbrand);
    border: solid 1px var(--figma-color-border-onbrand);
  }
  .button-action:disabled {
    background-color: var(--figma-color-bg-disabled);
    color: var(--figma-color-text-disabled);
    border: solid 1px var(--figma-color-border-disabled);
    cursor: not-allowed;
  }

  input,
  textarea {
    box-sizing: border-box;
    font-size: 0.7rem;
    color: var(--figma-color-text-primary);
    width: 100%;
    max-width: 100%;
    padding: 12px 8px;
    border: solid 1px transparent;
    border-radius: 2px;
    background: transparent;
  }
  textarea {
    font-family: Inter, sans-serif;
    border: solid 1px var(--figma-color-border);
    border-radius: 2px;
    padding: 8px;
  }
  input::placeholder,
  textarea::placeholder {
    color: var(--figma-color-text-tertiary);
  }
  input:hover,
  textarea:hover {
    border: solid 1px var(--figma-color-border);
  }
  input:focus,
  textarea:focus {
    outline: solid 2px var(--figma-color-border-selected);
  }
  input:disabled,
  textarea:disabled {
    color: var(--figma-color-text-disabled);
    cursor: not-allowed;
  }
</style>

<div class="node-design-ui --with-textarea">
  <div class="node-design-ui__textarea">
    <label for="InputTextContent">Text content</label>
    <textarea
      id="InputTextContent"
      rows="5"
      placeholder="Enter vertical text content..."
      required
    ></textarea>
  </div>
</div>

<div class="node-design-ui">
  <div class="node-design-ui__number">
    <label for="InputWidth">Width</label>
    <input
      id="InputWidth"
      placeholder="Auto"
      type="number"
      min="0"
      required
      disabled
    />
  </div>
  <div class="node-design-ui__number">
    <label for="InputHeight">Height</label>
    <input id="InputHeight" placeholder="Auto" type="number" min="0" required />
  </div>
</div>

<div class="node-design-ui">
  <div class="node-design-ui__number">
    <label for="InputLetterSpacing">Letter spacing</label>
    <input id="InputLetterSpacing" placeholder="0" type="number" required />
    <p>%</p>
  </div>
  <div class="node-design-ui__number">
    <label for="InputLineHeight">Line height</label>
    <!-- 計算ロジックが複雑になるのでひとまずmin: 100未満にならないようにする -->
    <input
      id="InputLineHeight"
      placeholder="Auto"
      type="number"
      min="100"
      required
    />
    <p>%</p>
  </div>
</div>

<div class="node-design-ui">
  <div class="node-design-ui__number">
    <label for="InputParagraphIndent">Paragraph Indent</label>
    <input id="InputParagraphIndent" placeholder="0" type="number" />
  </div>
  <div class="node-design-ui__number">
    <label for="InputParagraphSpacing">Paragraph Spacing</label>
    <input id="InputParagraphSpacing" placeholder="0" type="number" />
  </div>
</div>

<button id="ButtonAction" class="button-action" type="button" disabled="true">
  Convert / Sync
</button>

<hr class="plugin-divider" />
<div class="plugin-note">
  <svg
    width="15"
    height="15"
    viewbox="0 0 15 15"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M8.4449 0.608765C8.0183 -0.107015 6.9817 -0.107015 6.55509 0.608766L0.161178 11.3368C-0.275824 12.07 0.252503 13 1.10608 13H13.8939C14.7475 13 15.2758 12.07 14.8388 11.3368L8.4449 0.608765ZM7.4141 1.12073C7.45288 1.05566 7.54712 1.05566 7.5859 1.12073L13.9798 11.8488C14.0196 11.9154 13.9715 12 13.8939 12H1.10608C1.02849 12 0.980454 11.9154 1.02018 11.8488L7.4141 1.12073ZM6.8269 4.48611C6.81221 4.10423 7.11783 3.78663 7.5 3.78663C7.88217 3.78663 8.18778 4.10423 8.1731 4.48612L8.01921 8.48701C8.00848 8.766 7.7792 8.98664 7.5 8.98664C7.2208 8.98664 6.99151 8.766 6.98078 8.48701L6.8269 4.48611ZM8.24989 10.476C8.24989 10.8902 7.9141 11.226 7.49989 11.226C7.08567 11.226 6.74989 10.8902 6.74989 10.476C6.74989 10.0618 7.08567 9.72599 7.49989 9.72599C7.9141 9.72599 8.24989 10.0618 8.24989 10.476Z"
      fill="currentColor"
      fill-rule="evenodd"
      clip-rule="evenodd"
    ></path>
  </svg>
  <p>
    This plugin converts only text <strong>layout</strong> for vertical writing.
    To make the glyphs suitable for vertical writing, enable "Vertical
    alternates" and, if including alphabet and half glyphs, "Full widths"
    <a
      href="https://help.figma.com/hc/en-us/articles/4913951097367-Use-OpenType-features"
      target="_blank"
      rel="noopener noreferrer"
      >using OpenType features</a
    >.
  </p>
</div>

<script>
  const ButtonAction = document.getElementById("ButtonAction");
  const InputTextContent = document.getElementById("InputTextContent");
  const InputWidth = document.getElementById("InputWidth");
  const InputHeight = document.getElementById("InputHeight");
  const InputLetterSpacing = document.getElementById("InputLetterSpacing");
  const InputLineHeight = document.getElementById("InputLineHeight");
  const InputParagraphIndent = document.getElementById("InputParagraphIndent");
  const InputParagraphSpacing = document.getElementById(
    "InputParagraphSpacing"
  );

  let nodeId = "";

  // Ref: ./code.ts DataFromUI type
  const createDataForPlugin = () => {
    const data = {
      nodeId: nodeId,
      characters: InputTextContent.value ?? null,
      width: InputWidth.value ? Number(InputWidth.value) : null,
      height: InputHeight.value ? Number(InputHeight.value) : null,
      letterSpacing: {
        value: InputLetterSpacing.value ? Number(InputLetterSpacing.value) : 0,
        unit: "PERCENT",
      },
      lineHeight: {
        value: InputLineHeight.value ? Number(InputLineHeight.value) : null,
        unit: "PERCENT",
      },
      resizing: InputHeight.value ? null : "WIDTH_AND_HEIGHT",
      paragraphIndent: Number(InputParagraphIndent.value) ?? 0,
      paragraphSpacing: Number(InputParagraphSpacing.value) ?? 0,
    };
    return data;
  };

  ButtonAction.addEventListener("click", () => {
    const data = createDataForPlugin();
    // Ref: https://www.figma.com/plugin-docs/creating-ui/#non-null-origin-iframes
    parent.postMessage(
      {
        pluginMessage: { data },
        pluginId: "1146329653004129345",
      },
      "https://www.figma.com"
    );
  });

  onmessage = (event) => {
    const data = event.data.pluginMessage;
    if (!data) return;

    nodeId = data.nodeId;
    InputTextContent.value = data.characters;
    // InputWidth.value =
    //   data.resizing === "HEIGHT" || data.resizing === "WIDTH_AND_HEIGHT"
    //     ? null
    //     : data.width;
    InputHeight.value =
      data.resizing === "WIDTH_AND_HEIGHT" ? null : data.height;
    InputLetterSpacing.value = data.letterSpacing.value
      ? Number(data.letterSpacing.value.toFixed(3))
      : null;
    InputLineHeight.value = data.lineHeight.value
      ? Number(data.lineHeight.value.toFixed(3))
      : null;
    InputParagraphIndent.value = Number(data.paragraphIndent.toFixed(3));
    InputParagraphSpacing.value = Number(data.paragraphSpacing.toFixed(3));

    if (!nodeId) {
      ButtonAction.setAttribute("disabled", "true");
    } else {
      ButtonAction.removeAttribute("disabled");
    }
  };
</script>
